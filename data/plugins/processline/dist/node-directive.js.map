{"version":3,"sources":["../src/node-directive.js"],"names":["angular","_","kbn","$","module","directive","$compile","linkSrv","linkTemplate","createMenuTemplate","ctrl","template","dashboard","meta","canEdit","fullscreen","each","getMenu","item","role","click","href","text","getExtendedMenu","restrict","link","$scope","elem","$link","$panelLinksBtn","find","$panelContainer","parents","menuScope","timeout","$menu","teather","append","$watchCollection","newValue","showIcon","length","panel","title","toggle","dismiss","time","force","clearTimeout","setTimeout","is","$$panelDragging","destroy","unbind","remove","$destroy","removeClass","showMenu","e","contains","document","target","menuTemplate","hasClass","createExternalLinkMenu","mouseleave","$new","extendedMenu","toggleClass","$apply","contents","Tether","element","attachment","targetAttachment","constraints","to","pin"],"mappings":"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","file":"node-directive.js","sourcesContent":["import angular from 'angular';\nimport _ from  'lodash';\nimport kbn from 'app/core/utils/kbn';\nimport $ from 'jquery';\n\n  angular\n    .module('grafana.directives')\n    .directive('nodeMenu', function($compile, linkSrv) {\n      var linkTemplate ='hello'\n        /*  '<span class=\"panel-title drag-handle pointer\">' +\n            '<span class=\"panel-title-text drag-handle\">{{ctrl.panel.chartDataModel.nodes.name | interpolateTemplateVars:this}}</span>' +\n            '<span class=\"panel-links-btn\"><i class=\"fa fa-external-link\"></i></span>' +\n            '<span class=\"panel-time-info\" ng-show=\"ctrl.timeInfo\"><i class=\"fa fa-clock-o\"></i> {{ctrl.timeInfo}}</span>' +\n          '</span>';\n\n      function createExternalLinkMenu(ctrl) {\n        var template = '<div class=\"node-menu small\">';\n        template += '<div class=\"node-menu-row\">';\n\n        if (ctrl.panel.links) {\n          _.each(ctrl.panel.links, function(link) {\n            var info = linkSrv.getPanelLinkAnchorInfo(link, ctrl.panel.scopedVars);\n            template += '<a class=\"panel-menu-link\" href=\"' + info.href + '\" target=\"' + info.target + '\">' + info.title + '</a>';\n          });\n        }\n        return template;\n      }\n*/\n      function createMenuTemplate(ctrl) {\n        var template = '<div class=\"panel-menu small\" style=\"margin-top: -130px;\">';\n\n        if (ctrl.dashboard.meta.canEdit) {\n          template += '<div class=\"panel-menu-inner\">';\n          template += '<div class=\"panel-menu-row\">';\n          if (!ctrl.dashboard.meta.fullscreen) {\n            //template += '<a class=\"panel-menu-icon pull-left\" ng-click=\"ctrl.updateColumnSpan(-1)\"><i class=\"fa fa-minus\"></i></a>';\n            //template += '<a class=\"panel-menu-icon pull-left\" ng-click=\"ctrl.updateColumnSpan(1)\"><i class=\"fa fa-plus\"></i></a>';\n          }\n          template += '<a class=\"panel-menu-icon pull-right\" ng-click=\"ctrl.removeNode(ctrl.panel.chartDataModel.nodes)\"><i class=\"fa fa-trash\"></i></a>';\n         template += '<div class=\"clearfix\"></div>';\n          template += '</div>';\n        }\n\n        template += '<div class=\"panel-menu-row\">';\n        template += '<a class=\"panel-menu-link\" gf-dropdown=\"extendedMenu\"><i class=\"fa fa-bars\"></i></a>';\n\n        _.each(ctrl.getMenu(), function(item) {\n          // skip edit actions if not editor\n          if (item.role === 'Editor' && !ctrl.dashboard.meta.canEdit) {\n            return;\n          }\n\n          template += '<a class=\"panel-menu-link\" ';\n          if (item.click) { template += ' ng-click=\"' + item.click + '\"'; }\n          if (item.href) { template += ' href=\"' + item.href + '\"'; }\n          template += '>';\n          template += item.text + '</a>';\n        });\n\n        template += '</div>';\n        template += '</div>';\n        template += '</div>';\n        return template;\n      }\n\n      function getExtendedMenu(ctrl) {\n        return ctrl.getExtendedMenu();\n      }\n\n      return {\n        restrict: 'A',\n        link: function($scope, elem) {\n          var $link = $(linkTemplate);\n          var $panelLinksBtn = $link.find(\".panel-links-btn\");\n          var $panelContainer = elem.parents(\".panel-container\");\n          var menuScope = null;\n          var ctrl = $scope.ctrl;\n          var timeout = null;\n          var $menu = null;\n          var teather;\n\n          elem.append($link);\n\n          $scope.$watchCollection('ctrl.panel.links', function(newValue) {\n            var showIcon = (newValue ? newValue.length > 0 : false) && ctrl.panel.title !== '';\n            $panelLinksBtn.toggle(showIcon);\n          });\n\n          function dismiss(time, force) {\n            clearTimeout(timeout);\n            timeout = null;\n\n            if (time) {\n              timeout = setTimeout(dismiss, time);\n              return;\n            }\n\n            // if hovering or draging pospone close\n            if (force !== true) {\n              if ($menu.is(':hover') || $scope.ctrl.dashboard.$$panelDragging) {\n                dismiss(2200);\n                return;\n              }\n            }\n\n            if (menuScope) {\n              teather.destroy();\n              $menu.unbind();\n              $menu.remove();\n              menuScope.$destroy();\n              menuScope = null;\n              $menu = null;\n              $panelContainer.removeClass('panel-highlight');\n            }\n          }\n\n          var showMenu = function(e) {\n            // if menu item is clicked and menu was just removed from dom ignore this event\n            if (!$.contains(document, e.target)) {\n              return;\n            }\n\n            if ($menu) {\n              dismiss();\n              return;\n            }\n\n            var menuTemplate;\n            if ($(e.target).hasClass('fa-external-link')) {\n              menuTemplate = createExternalLinkMenu(ctrl);\n            } else {\n              menuTemplate = createMenuTemplate(ctrl);\n            }\n\n            $menu = $(menuTemplate);\n            $menu.mouseleave(function() {\n              dismiss(1000);\n            });\n\n            menuScope = $scope.$new();\n            menuScope.extendedMenu = getExtendedMenu(ctrl);\n            menuScope.dismiss = function() {\n              dismiss(null, true);\n            };\n\n            $(\".panel-container\").removeClass('panel-highlight');\n            $panelContainer.toggleClass('panel-highlight');\n\n            $('.panel-menu').remove();\n\n            elem.append($menu);\n\n            $scope.$apply(function() {\n              $compile($menu.contents())(menuScope);\n\n              teather = new Tether({\n                element: $menu,\n                target: $panelContainer,\n                attachment: 'bottom center',\n                targetAttachment: 'top center',\n                constraints: [\n                  {\n                    to: 'window',\n                    attachment: 'together',\n                    pin: true\n                  }\n                ]\n              });\n            });\n\n            dismiss(2200);\n          };\n\n          elem.click(showMenu);\n          $compile(elem.contents())($scope);\n        }\n      };\n    });\n\n"]}